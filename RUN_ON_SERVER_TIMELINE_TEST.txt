# ============================================
# TIMELINE API TEST - RUN ON SERVER
# ============================================
# 
# SSH into server first:
# ssh -i "C:\Users\Admin\awsconection.pem" ubuntu@16.171.161.150
#
# Then run these commands:
# ============================================

# Step 1: Login and get token
echo "=== STEP 1: LOGIN ==="
TOKEN=$(curl -s -k -X POST https://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | jq -r '.token')

echo "Token: $TOKEN"
echo ""

# Step 2: Test Product Timeline
echo "=== STEP 2: PRODUCT TIMELINE ==="
echo "GET /api/timeline/2460-3499"
echo ""

curl -s -k -X GET "https://localhost:3001/api/timeline/2460-3499" \
  -H "Authorization: Bearer $TOKEN" | jq '.'

echo ""
echo ""

# Step 3: Test with barcode that has dispatches
echo "=== STEP 3: PRODUCT TIMELINE (2251-999) ==="
echo "GET /api/timeline/2251-999"
echo ""

curl -s -k -X GET "https://localhost:3001/api/timeline/2251-999" \
  -H "Authorization: Bearer $TOKEN" | jq '.' > timeline_2251.json

cat timeline_2251.json | jq '.data.summary'
echo ""
echo "Timeline events count:"
cat timeline_2251.json | jq '.data.timeline | length'
echo ""
echo "First 3 events:"
cat timeline_2251.json | jq '.data.timeline[0:3]'
echo ""

# Step 4: Extract dispatch ID and test nested timeline
echo "=== STEP 4: NESTED DISPATCH TIMELINE ==="
DISPATCH_REF=$(cat timeline_2251.json | jq -r '.data.timeline[] | select(.type=="DISPATCH") | .reference' | head -1)
echo "First DISPATCH reference: $DISPATCH_REF"

# Extract ID (handle both DISPATCH_22_898989 and DISPATCH_DELETE_22 formats)
if [[ $DISPATCH_REF == DISPATCH_DELETE_* ]]; then
    DISPATCH_ID=$(echo $DISPATCH_REF | cut -d'_' -f3)
else
    DISPATCH_ID=$(echo $DISPATCH_REF | cut -d'_' -f2)
fi

echo "Extracted Dispatch ID: $DISPATCH_ID"
echo ""
echo "GET /api/order-tracking/$DISPATCH_ID/timeline"
echo ""

curl -s -k -X GET "https://localhost:3001/api/order-tracking/$DISPATCH_ID/timeline" \
  -H "Authorization: Bearer $TOKEN" | jq '.' > nested_timeline.json

echo "=== DISPATCH DETAILS ==="
cat nested_timeline.json | jq '.data.dispatch'
echo ""

echo "=== TIMELINE EVENTS ==="
cat nested_timeline.json | jq '.data.timeline | length'
echo "events found"
echo ""
cat nested_timeline.json | jq '.data.timeline[0:3]'
echo ""

echo "=== SUMMARY ==="
cat nested_timeline.json | jq '.data.summary'

# ============================================
# ALTERNATIVE: One-liner commands
# ============================================
# If the above doesn't work, run these one by one:

# 1. Get token:
# TOKEN=$(curl -s -k -X POST https://localhost:3001/api/auth/login -H "Content-Type: application/json" -d '{"username":"admin","password":"admin123"}' | jq -r '.token') && echo $TOKEN

# 2. Test product timeline:
# curl -s -k "https://localhost:3001/api/timeline/2251-999" -H "Authorization: Bearer $TOKEN" | jq '.data.summary'

# 3. Test nested timeline (use dispatch ID 19):
# curl -s -k "https://localhost:3001/api/order-tracking/19/timeline" -H "Authorization: Bearer $TOKEN" | jq '.data.dispatch'
