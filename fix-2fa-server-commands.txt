#!/bin/bash
# 2FA DATABASE FIX COMMANDS FOR SERVER
# Run these commands on your server (52.221.231.85)

echo "ðŸ”§ Fixing 2FA backup codes database issue..."

# Connect to MySQL and fix the backup codes
sudo mysql -e "
USE inventory_db;

-- Show current state
SELECT 'BEFORE FIX:' as status;
SELECT 
    id, 
    name, 
    two_factor_backup_codes,
    JSON_VALID(two_factor_backup_codes) as is_valid_json
FROM users 
WHERE two_factor_backup_codes IS NOT NULL;

-- Fix the backup codes (convert comma-separated to JSON array)
UPDATE users 
SET two_factor_backup_codes = '[\"CA1EAEE4\",\"F1228D17\",\"D619399F\",\"2FC39886\",\"D37E6C7A\",\"A9B78C38\",\"3D2575E6\",\"B8862F4D\",\"8D9C2BFD\",\"6E383380\"]'
WHERE id = 1 
AND two_factor_backup_codes = 'CA1EAEE4,F1228D17,D619399F,2FC39886,D37E6C7A,A9B78C38,3D2575E6,B8862F4D,8D9C2BFD,6E383380';

-- Show results after fix
SELECT 'AFTER FIX:' as status;
SELECT 
    id, 
    name,
    two_factor_backup_codes,
    JSON_VALID(two_factor_backup_codes) as is_valid_json,
    JSON_LENGTH(two_factor_backup_codes) as backup_codes_count
FROM users 
WHERE two_factor_backup_codes IS NOT NULL;
"

echo "âœ… Database fix completed!"

# Restart the Node.js server to apply the code changes
echo "ðŸ”„ Restarting Node.js server..."
pm2 restart all

echo "ðŸ§ª Testing 2FA API..."
curl -k -X POST https://52.221.231.85:8443/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@company.com","password":"admin@123"}' \
  | jq '.'

echo "ðŸŽ‰ Fix completed! The 2FA system should now work properly."