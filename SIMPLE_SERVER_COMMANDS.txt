ðŸš€ COPY AND PASTE THESE COMMANDS ON YOUR SERVER
================================================

cd /home/ubuntu/inventoryfullstack

# Stop server
pkill -f "node server.js"
sleep 3

# Install dependencies
npm install bcryptjs axios

# Apply controller fix (add callbacks to prevent MySQL errors)
cp controllers/permissionsController.js controllers/permissionsController.js.backup
node -e "
const fs = require('fs');
let content = fs.readFileSync('controllers/permissionsController.js', 'utf8');
content = content.replace(/PermissionsController\.createAuditLog\(([^)]+)\);/g, 'PermissionsController.createAuditLog(\$1, () => {});');
fs.writeFileSync('controllers/permissionsController.js', content);
console.log('âœ… Controller fixed');
"

# Apply test fix (fix return API field names)
cp comprehensive-nested-user-journey-test.js comprehensive-nested-user-journey-test.js.backup
node -e "
const fs = require('fs');
let content = fs.readFileSync('comprehensive-nested-user-journey-test.js', 'utf8');
content = content.replace(/product_name: dispatchData\.product_name,/g, 'product_type: dispatchData.product_name,\\n            warehouse: dispatchData.warehouse,');
content = content.replace(/product_name: multiDispatchData\.product_name,/g, 'product_type: multiDispatchData.product_name,\\n            warehouse: multiDispatchData.warehouse,');
content = content.replace(/product_name: amitDispatchData\.product_name,/g, 'product_type: amitDispatchData.product_name,\\n            warehouse: amitDispatchData.warehouse,');
content = content.replace(/reason: 'Customer return',/g, \"return_reason: 'Customer return',\");
content = content.replace(/return_type: 'customer_return'/g, \"condition: 'good'\");
content = content.replace(/reason: 'Quality issue',/g, \"return_reason: 'Quality issue',\");
content = content.replace(/return_type: 'quality_issue'/g, \"condition: 'good'\");
content = content.replace(/reason: 'Wrong item',/g, \"return_reason: 'Wrong item',\");
content = content.replace(/return_type: 'wrong_item'/g, \"condition: 'good'\");
fs.writeFileSync('comprehensive-nested-user-journey-test.js', content);
console.log('âœ… Test file fixed');
"

# Start server
nohup node server.js > server.log 2>&1 &
sleep 5

# Check server
ps aux | grep "node server.js" | grep -v grep

# Run test
node comprehensive-nested-user-journey-test.js

================================================
WHAT THESE FIXES DO:
1. Fix MySQL callback errors in permissions controller
2. Fix return API field mapping (product_name -> product_type, add warehouse)
3. Install missing bcryptjs dependency
4. Run the comprehensive test with all fixes applied
================================================